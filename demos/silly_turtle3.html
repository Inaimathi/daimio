<!doctype html> 
<html> 
<head> 
  <meta charset="utf-8">
  <title>I Like Turtles</title>
  <script type="text/javascript" src="http://sherpa.local/~dann/daimio/get.php?file=node_modules/daimio"></script>
</head>

<body>

  <svg id="mainsvg" width="800px" height="500px" viewBox="0 0 800 500"></svg>
  
  <div style="float:right; width: 320px; overflow: auto">
    <pre id="hints">
      
{forward 10} {turn 10}

{forward 10 | turn 10}

{10 | forward | turn}

{ 120 | forward | turn 
| forward | turn | forward | turn}

{90 | forward | turn}

{range 4 | do "{90 | forward | turn}"}

Other math commands:
{math mod value 7 by 2}
{math pow value 2 exp 8}
{math sin value 90}
{math cos value 90}
{math round value 1.234}

    </pre>
  </div>
  
  <form id="codeform">
    <div><textarea id="code" name="code" rows="4" cols="100"></textarea></div>
    <div><input type="submit" name="send" value="send" id="send" /></div>
  </form>
  
  <pre id="morehints">
{range 5 | do "{144 | forward | turn}"}

{range 5 | do "{turn 10 | range 5 | do "{ 144 | forward | turn | wait}"}"}

{range 5 | do "{turn 90 | forward 20 | turn 270 | forward 20 | wait}"}"}

{range 5 | do "{turn 90 | forward 20 | turn 270 | forward 20 |  turn 270 | forward 20 | wait}"}"}

{range 8 |  do "{turn 45 | range 5 | do "{turn 90 | forward 50 | turn 270 | forward 50 |  turn 270 | forward 50 | wait}"}"}"}

{range 36 | do "{turn 10 | range 4 | do "{90 | forward | turn | wait}"}"}

{range 400 | do "{__ | times 0.04 | add 3.2 | forward | turn 14.2 | wait}"}

{7 | range 200 | do "{__ | divide value 200 | forward | turn -16.3 | wait}"}

{range 12 | do "{7 | range 100 | do "{__ | divide value 100 | forward | turn -14.1 | wait}"}"}

{range 10 | do "{range 9 | do "{forward 100 | turn 200 | wait}" | turn 36}"}

{range 4 | do "{range 100 | list reverse | do "{__ | turn | forward 10 | wait}" | turn 60}"}

{range 400 | do "{forward 5 | math randomÂ max 4 | times 90 | turn | wait}"}

  </pre>
  
  <!-- {range 4 | do "{turn 100 | range 100 | list reverse | do "{__ | turn | forward 10 | wait}"}"} -->
  
  <script type="text/daimio" id="spaceseeds">
    execspace
      {"minus": {}}
      @execport exec
      @forward out
      @turn out
      
    outer
      @codeform 
        dom-on-submit
      
      @svg-move
      @svg-rotate
      @svg-add-line
      
      @socket-add-user
      @socket-remove-user
      @socket-in
      @socket-out
      
      @turtle-add
      
      $colors 
        [ "blue", "blueviolet", "cadetblue", "chartreuse", "coral", "cornflowerblue"
        , "crimson", "cyan", "darkblue", "darkcyan", "darkgoldenrod", "darkgreen"
        , "darkkhaki", "darkmagenta", "darkolivegreen", "darkorange", "darkorchid"
        , "darkred", "darksalmon", "darkseagreen", "darkslateblue", "darkturquoise"
        , "darkviolet", "deeppink", "deepskyblue", "firebrick", "forestgreen", "fuchsia"
        , "gainsboro", "goldenrod", "green", "greenyellow", "hotpink", "indianred", "indigo"
        , "lavenderblush", "lawngreen", "limegreen", "linen", "magenta", "moccasin", "navy"
        , "olive", "olivedrab", "orange", "orangered", "peru", "pink", "plum", "purple", "red"
        , "rosybrown", "royalblue", "salmon", "sandybrown", "seagreen", "slateblue", "springgreen"
        , "steelblue", "teal", "tomato", "turquoise", "violet" ]
      
      turtle-fix 
        { __ | > :ship 
        | $colors.{$ship.user | times 13 | mod {$colors | count}} | > :ship.color 
        | * (:angle 0 :x 200 :y 200 :alpha 0.8 :color $ship.color) 
        | > {"turtles.{$ship.user}" | run} | $ship}

      turn-fix 
        { __ | > :ship 
        | * ( :angle 
              {$turtles.{$ship.user}.angle | add $ship.result | > {"turtles.{$ship.user}.angle" | run}} 
              :thing 
              {"turtle{$ship.user}" | run} ) }
        
/      turn-fix 
/        { __ | >_ship 
/        | __.user | >_user
/        | $turtles.{_user}.angle | add _ship.result | >$turtles.{_user}.angle | >_angle
/        | * ( :angle _angle
/              :thing {"turtle{_user}"} ) 
/        | >@svg-rotate}

/      turn-fix 
/        { __ | _>ship 
/        | __.user | _>user
/        | $turtles.{_user}.angle | add _ship.result | $>turtles.{_user}.angle | _>angle
/        | * ( :angle _angle
/              :thing {"turtle{_user}"} ) 
/        | @>svg-rotate}

/      turn-fix 
/        { __ | >_ :ship 
/        | __.user | >_ :user
/        | $turtles.{_user}.angle | add _ship.result | >$ {"turtles.{_user}.angle"} | >_ :angle
/        | * ( :angle _angle
/              :thing {"turtle{_user}"} ) 
/        | >@ :svg-rotate}
        
/      turn-fix 
/        { __ | -> (:user :result)
/        | $turtles.{_user}.angle | add _result | $> {"turtles.{_user}.angle"} | -> :angle
/        | * ( :angle _angle
/              :thing {"turtle{_user}"} ) 
/        | @> :svg-rotate}

/      turn-fix 
/        { __ | -> (:user :result)
/        | $turtles.{-user}.angle | add -result | $> {"turtles.{-user}.angle"} | -> :angle
/        | * ( :angle -angle
/              :thing {"turtle{-user}"} ) 
/        | @> :svg-rotate}
       
// add {math bound by (0 750)} command
// maybe...
// {_dx | add $turtles.{_user}.x | math bound by (0 750) | $>turtles.{_user}.x}
// but really something like 
// {$turtles.{_user} | link :turtle | _dx | add ~turtle.x | math bound by (0 750) | $>turtle.x}
// might be nicer for these long painful things...

      
/      forward-fix 
/        { __ | -> (:user :result)
/        | $turtles.{_user} | ->turtle
/        | _turtle.angle | add 90 | math cos | times _result | add _turtle.x | math bound by (0 750) | ->newx
/        | _turtle.angle | add 90 | math sin | times _result | add _turtle.y | math bound by (0 450) | ->newy
/        | * (:x newx :y newy) | extend _turtle | $>turtles.{_user}
/        | extend with {* (:thing {"turtlebox{_user}"})}
/        | port send name :move 
/        | * ( :x1 {_turtle.x | add 15} 
/              :y1 {_turtle.y | add 15} 
/              :x2 {_newx | add 15} 
/              :y2 {_newy | add 15} 
/              :color _turtle.color 
/              :alpha _turtle.alpha 
/              :thing :mainsvg ) 
/        | port send name :add-line}

// THINK: how do we clean up the 'add 90 | math (sin|cos) | etc...' ?
// { "{_turtle.angle | add 90 | _fun | times _result | add _offset | math bound by (0 _max)}" | as :convert
// | _turtle.x | convert fun "{__ | math sin}" max 750 | ->newx
// | _turtle.y | convert fun "{__ | math cos}" max 450 | ->newy }
// so 'convert' goes in the dialect as an 'immediately compiled' command/alias... what about _result? is it shadowed? does it take a param?
// honestly, though, the repetitive version is easier to read...
      
      forward-fix 
        { __ | > :ship 
        | $turtles.{$ship.user}.x | > :oldx 
        | $turtles.{$ship.user}.y | > :oldy 
        | $turtles.{$ship.user}.angle | add 90 | math cos | times $ship.result | > :dx 
        | add $turtles.{$ship.user}.x | > {"turtles.{$ship.user}.x" | run} 
        | less than 0 | then 0 else $turtles.{$ship.user}.x | > {"turtles.{$ship.user}.x" | run} 
        | 750 | less than $turtles.{$ship.user}.x 
        | then 750 else $turtles.{$ship.user}.x | > {"turtles.{$ship.user}.x" | run} 
        | $turtles.{$ship.user}.angle | add 90 | math sin | times $ship.result | > :dy 
        | add $turtles.{$ship.user}.y | > {"turtles.{$ship.user}.y" | run} 
        | less than 0 | then 0 else $turtles.{$ship.user}.y | > {"turtles.{$ship.user}.y" | run} 
        | 450 | less than $turtles.{$ship.user}.y 
        | then 450 else $turtles.{$ship.user}.y | > {"turtles.{$ship.user}.y" | run} 
        | * (:y $turtles.{$ship.user}.y :x $turtles.{$ship.user}.x :thing {"turtlebox{$ship.user}" | run}) 
        | port send name :svg-move 
        | * ( :x1 {$oldx | add 15} 
              :y1 {$oldy | add 15} 
              :x2 {$turtles.{$ship.user}.x | add 15} 
              :y2 {$turtles.{$ship.user}.y | add 15} 
              :color $turtles.{$ship.user}.color 
              :alpha $turtles.{$ship.user}.alpha 
              :thing :mainsvg) 
        | port send name :svg-add-line}
      
      @codeform -> @socket-out
      @socket-in -> execspace.execport
   // execspace.forward -> forward-fix -> (@svg-move @svg-add-line)
   // forward-fix.move -> @svg-move
   // forward-fix.add-line -> @svg-add-line
      execspace.forward -> forward-fix -> @svg-move 
      forward-fix -> @svg-add-line
      execspace.turn -> turn-fix -> @svg-rotate
      @socket-add-user -> turtle-fix -> @turtle-add
      
  </script>
  
  <script type="text/json" id="spaceseeds2">
    { execspace:
      { dialect: {}
      , ports: 
        { "execport": ["exec"]
        , "forward": ["out"]
        , "turn": ["out"]
        }
      }
      
    , outer: 
      { ports: 
        { "codeform": ["dom-on-submit"]
        , "svg-move": ["svg-move"]
        , "svg-rotate": ["svg-rotate"]
        , "svg-add-line": ["svg-add-line"]
        , "socket-add-user": ["socket-add-user"]
        , "socket-remove-user": ["socket-remove-user"]
        , "socket-in": ["socket-in"]
        , "socket-out": ["socket-out"]
        , "turtle-add": ["turtle-add"]
        }
      , state: 
        { colors: ["aliceblue", "aqua", "aquamarine", "azure", "blue", "blueviolet", "brown", "burlywood", "cadetblue", "chartreuse", "chocolate", "coral", "cornflowerblue", "crimson", "cyan", "darkblue", "darkcyan", "darkgoldenrod", "darkgreen", "darkkhaki", "darkmagenta", "darkolivegreen", "darkorange", "darkorchid", "darkred", "darksalmon", "darkseagreen", "darkslateblue", "darkturquoise", "darkviolet", "deeppink", "deepskyblue", "dodgerblue", "firebrick", "forestgreen", "fuchsia", "gainsboro", "gold", "goldenrod", "green", "greenyellow", "honeydew", "hotpink", "indianred", "indigo", "lavender", "lavenderblush", "lawngreen", "lemonchiffon", "lime", "limegreen", "linen", "magenta", "maroon", "midnightblue", "mintcream", "mistyrose", "moccasin", "navy", "oldlace", "olive", "olivedrab", "orange", "orangered", "orchid", "palegoldenrod", "palegreen", "paleturquoise", "palevioletred", "papayawhip", "peachpuff", "peru", "pink", "plum", "powderblue", "purple", "red", "rosybrown", "royalblue", "saddlebrown", "salmon", "sandybrown", "seagreen", "seashell", "sienna", "silver", "skyblue", "slateblue", "snow", "springgreen", "steelblue", "teal", "thistle", "tomato", "turquoise", "violet", "yellowgreen"]}
      , subspaces: 
        { execs: "execspace"}
      , stations: // TODO: needs A) line breaks B) a "between" command C) var access sugar D) var setting sugar
        { forward_fix: '{__ | > :ship | $turtles.{$ship.user}.x | > :oldx | $turtles.{$ship.user}.y | > :oldy | $turtles.{$ship.user}.angle | add 90 | math cos | times $ship.result | > :dx | add $turtles.{$ship.user}.x | > {"turtles.{$ship.user}.x" | run} | less than 0 | then 0 else $turtles.{$ship.user}.x | > {"turtles.{$ship.user}.x" | run} | 750 | less than $turtles.{$ship.user}.x | then 750 else $turtles.{$ship.user}.x | > {"turtles.{$ship.user}.x" | run} | $turtles.{$ship.user}.angle | add 90 | math sin | times $ship.result | > :dy | add $turtles.{$ship.user}.y | > {"turtles.{$ship.user}.y" | run} | less than 0 | then 0 else $turtles.{$ship.user}.y | > {"turtles.{$ship.user}.y" | run} | 450 | less than $turtles.{$ship.user}.y | then 450 else $turtles.{$ship.user}.y | > {"turtles.{$ship.user}.y" | run} | * (:y $turtles.{$ship.user}.y :x $turtles.{$ship.user}.x :thing {"turtlebox{$ship.user}" | run}) | port send name :svg-move | * (:y1 {$oldy | add 15} :x1 {$oldx | add 15} :x2 {$turtles.{$ship.user}.x | add 15} :y2 {$turtles.{$ship.user}.y | add 15} :color $turtles.{$ship.user}.color :alpha $turtles.{$ship.user}.alpha :thing :mainsvg) | port send name :svg-add-line}'
        , turn_fix: '{__ | > :ship | * (:angle {$turtles.{$ship.user}.angle | add $ship.result | > {"turtles.{$ship.user}.angle" | run}} :thing {"turtle{$ship.user}" | run}) | @> :svg-rotate}'
        , turtle_fix: '{__ | > :ship | $colors.{$ship.user | times 13 | mod {$colors | count}} | > :ship.color | * (:angle 0 :x 200 :y 200 :alpha 0.8 :color $ship.color) | > {"turtles.{$ship.user}" | run} | $ship}'
        }
      , routes: 
        [ ['codeform', 'socket-out']
        // , ['cleaner.out', 'execs.execport'] 
        , ['socket-in', 'execs.execport'] 
        , ['execs.forward', 'forward_fix.in']
        , ['execs.turn', 'turn_fix.in']
        , ['socket-add-user', 'turtle_fix.in']
        , ['turtle_fix.out', 'turtle-add']
        ]
      }
    }
    // yicky yick this is ugly
  </script>
  
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">    
    document.addEventListener('DOMContentLoaded', function() {
      socket = io.connect('http://sherpa.local:8008') // published for demo (icky)
      
      var seedlikes = document.getElementById('spaceseeds').text
      var outerseed = D.make_some_space(seedlikes)
      OuterSpace = new D.Space(outerseed) // published for debug
    })
    
    
    /*
      TODOS!!!
      -- exec port
      -- lines working
      -- turtle line working
      -- network (websockets / webrtc) stuff... like USER
      -- code sending working
      -- new turtle per user
      -- good job
      
      - audio code
      - cm editor for turtle code
      - pause space
      - svg display of spaces
      - spacial processing limits
      - concurrency code (turtle intersection?)
      - live updates
    */
    
  </script>
  
</body>
</html>