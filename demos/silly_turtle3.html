<!doctype html> 
<html> 
<head> 
  <meta charset="utf-8">
  <title>I Like Turtles</title>
  <script type="text/javascript" src="http://sherpa.local/~dann/daimio/node_modules/underscore/underscore.js"></script>
  <script type="text/javascript" src="http://sherpa.local/~dann/daimio/get.php?file=node_modules/daml"></script>
</head>

<body>

  <svg id="mainsvg" width="500px" height="500px" viewBox="0 0 500 500">
    <g id="turtlebox" transform="translate(30,30)">
      <rect width="30" height="50" id="turtle"></rect>
    </g>
  </svg>
  
  <form id="codeform">
    <div><textarea id="code" name="code" rows="10" cols="80"></textarea></div>
    <div><input type="submit" name="send" value="send" id="send" /></div>
  </form>
  
  <pre id="hints">
    {forward 10}
    {turn 10}
    
    {range 360 | each block "{__ | turn | process sleep}"}
  </pre>
  
  <script type="text/json" id="spaceseeds">
    { execspace:
      { dialect: {}
      , ports: 
        { "execport": ["exec"]
        , "forward": ["out"]
        , "turn": ["out"]
        }
      }
      
    , outer: 
      { ports: 
        { "codeform": ["dom-submit-track"]
        , "svg-move": ["svg-move"]
        , "svg-rotate": ["svg-rotate"]
        , "svg-line-add": ["svg-line-add"]
        , "socket-connect": ["socket-connect"]
        , "socket-disconnect": ["socket-disconnect"]
        , "socket-in": ["socket-in"]
        , "socket-out": ["socket-out"]
        }
      , state: 
        { angle: 0
        , x: 30
        , y: 30
        , alpha: 0.5
        , color: "green"
        }
      , subspaces: 
        { execs: "execspace"}
      , stations: 
        { cleaner: "{__ | > :f | * (:code $f.code :user 5)}" 
        , forward_fix: '{__ | > :ship | $ship.result | $x | > :oldx | $y | > :oldy | $angle | add 90 | math cos | times $ship.result | > :dx | add $x | > :x | less than 0 | then 0 else $x | > :x | 450 | less than $x | then 450 else $x | > :x | $angle | add 90 | math sin | times $ship.result | > :dy | add $y | > :y | less than 0 | then 0 else $y | > :y | 450 | less than $y | then 450 else $y | > :y | * (:y $y :x $x :thing :turtlebox) | port send name :svg-move} {* (:y1 {$oldy | add 15} :x1 {$oldx | add 15} :x2 {$x | add 15} :y2 {$y | add 15} :color $color :alpha $alpha :thing :mainsvg) | port send name :svg-line-add}'
        , turn_fix: "{__ | > :ship | $ship.result | * (:angle {$angle | add $ship.result | > :angle} :thing :turtle) | @> :svg-rotate}"
        }
      , routes: 
        [ ['codeform', 'socket-out']
        // , ['cleaner.out', 'execs.execport'] 
        , ['socket-in', 'execs.execport'] 
        , ['execs.forward', 'forward_fix.in']
        , ['execs.turn', 'turn_fix.in']
        ]
      }
    }
    // yicky yick this is ugly
  </script>
  
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">    
    document.addEventListener('DOMContentLoaded', function() {
      socket = io.connect('http://sherpa.local:8008') // published for demo (icky)
      
      eval('var seedlikes = ' + document.getElementById('spaceseeds').text) // OH NO WHY ARE YOU DOING THIS
      var outerseed = DAML.make_some_space(seedlikes)
      OuterSpace = new DAML.Space(outerseed) // published for debug
    })
    
    
    /*
      TODOS!!!
      -- exec port
      -- lines working
      -- turtle line working
      -- network (websockets / webrtc) stuff... like USER
      -- code sending working
      - new turtle per user
      - good job
      - pause space
      - svg display of spaces
      - spacial processing limits
      - cm editor for turtle code
      - audio code
      - concurrency code (turtle intersection?)
      - live updates? maybe not for this one...
    */
    
  </script>
  
</body>
</html>